<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>Tasks</title>
</head>
<body>
<div layout:fragment="content">
    <h1>Here will be all tasks :)</h1>

    <form th:action="@{/tasks}" method="get" class="mb-3 d-flex align-items-center content-wrapper" style="gap:8px;">
        <input type="hidden" name="page" value="0"/>
        <input type="hidden" name="size" th:value="${pageSize}"/>
        <input type="hidden" name="sort" th:value="${currentSort}">
        <input type="hidden" name="direction" th:value="${currentDirection}">
        <input type="text" name="title" class="form-control" placeholder="Search by title..." maxlength="30" style="width:180px;"
               th:value="${searchTitle}">

        <label class="me-2 mb-0 fw-bold">Status:</label>
        <select name="status" class="form-select me-2" style="width: auto;">
            <option value="" th:selected="${selectedStatus == null or selectedStatus == ''}">All</option>
            <option th:value="'TODO'" th:selected="${selectedStatus == 'TODO'}">To do</option>
            <option th:value="'IN_PROGRESS'" th:selected="${selectedStatus == 'IN_PROGRESS'}">In progress</option>
            <option th:value="'DONE'" th:selected="${selectedStatus == 'DONE'}">Done</option>
        </select>

        <label class="me-2 mb-0 fw-bold">Category:</label>
        <select name="categoryId" class="form-select me-2" style="width: auto;">
            <option value="" th:selected="${selectedCategory == null or selectedCategory == ''}">All</option>
            <option th:each="cat : ${categories}"
                    th:value="${cat.id}"
                    th:text="${cat.name}"
                    th:selected="${selectedCategory != null and selectedCategory == cat.id}">
            </option>
        </select>

        <label class="me-2 mb-0 fw-bold">Due after:</label>
        <input type="date" name="dueAfter" class="form-control me-2" style="width:160px;"
               th:value="${dueAfter}"/>

        <label class="me-2 mb-0 fw-bold">Due before:</label>
        <input type="date" name="dueBefore" class="form-control me-2" style="width:160px;"
               th:value="${dueBefore}"/>

        <button type="submit" class="btn btn-primary">Filter / Search</button>
    </form>
    <form th:action="@{/tasks/export}" method="get" style="display:inline;">
        <button type="submit" class="btn btn-outline-info">Export CSV</button>
    </form>

    <form th:action="@{/tasks/import}" method="post" enctype="multipart/form-data" style="display:inline; margin-left: 10px;">
        <input type="file" name="file" accept=".csv" required class="form-control d-inline" style="width: auto; display: inline-block;">
        <button type="submit" class="btn btn-outline-success">Import CSV</button>
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
    </form>

    <table class="table">
        <thead>
        <tr>
            <th>
                <a th:with="nextDir=${currentSort == 'title' and currentDirection == 'asc' ? 'desc' : 'asc'}"
                   th:href="@{/tasks(sort='title', direction=${nextDir}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=0, size=${pageSize})}">
                    Title
                    <span th:if="${currentSort == 'title'}"
                          th:text="${currentDirection == 'asc' ? '▲' : '▼'}"></span>
                </a>
            </th>

            <th>
                <a th:with="nextDir=${currentSort == 'description' and currentDirection == 'asc' ? 'desc' : 'asc'}"
                   th:href="@{/tasks(sort='description', direction=${nextDir}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=0, size=${pageSize})}">
                    Description
                    <span th:if="${currentSort == 'description'}"
                          th:text="${currentDirection == 'asc' ? '▲' : '▼'}"></span>
                </a>
            </th>

            <th>
                <a th:with="nextDir=${currentSort == 'category.name' and currentDirection == 'asc' ? 'desc' : 'asc'}"
                   th:href="@{/tasks(sort='category.name', direction=${nextDir}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=0, size=${pageSize})}">
                    Category
                    <span th:if="${currentSort == 'category.name'}"
                          th:text="${currentDirection == 'asc' ? '▲' : '▼'}"></span>
                </a>
            </th>

            <th>
                <a th:with="nextDir=${currentSort == 'dueDate' and currentDirection == 'asc' ? 'desc' : 'asc'}"
                   th:href="@{/tasks(sort='dueDate', direction=${nextDir}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=0, size=${pageSize})}">
                    Due date
                    <span th:if="${currentSort == 'dueDate'}"
                          th:text="${currentDirection == 'asc' ? '▲' : '▼'}"></span>
                </a>
            </th>

            <th>
                <a th:with="nextDir=${currentSort == 'status' and currentDirection == 'asc' ? 'desc' : 'asc'}"
                   th:href="@{/tasks(sort='status', direction=${nextDir}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=0, size=${pageSize})}">
                    Status
                    <span th:if="${currentSort == 'status'}"
                          th:text="${currentDirection == 'asc' ? '▲' : '▼'}"></span>
                </a>
            </th>

        </tr>
        </thead>
        <tbody>
        <tr th:each="task : ${tasks}">
            <td>
                <a th:href="@{/tasks/{id}(id=${task.id})}" class="btn btn-link p-0" th:text="${task.title}"></a>
            </td>
            <td th:text="${task.description}"></td>

            <td>
                <span th:if="${task.category != null and task.category.color != null}"
                      th:style="'display:inline-block;padding:4px 10px;border-radius:6px;color:#fff;font-weight:500;background-color:' + ${task.category.color}"
                      th:text="${task.category.name}"></span>
                <span th:if="${task.category != null and task.category.color == null}"
                      th:text="${task.category.name}"></span>
                <span th:if="${task.category == null}" th:text="'Brak'"></span>
            </td>

            <td th:text="${#temporals.format(task.dueDate, 'dd.MM.yyyy')}"></td>
            <td th:text="${task.status}"></td>
        </tr>
        </tbody>
    </table>

    <p th:if="${#lists.isEmpty(tasks)}">No tasks found.</p>

    <div th:if="${page != null and page.totalPages > 1}" class="d-flex justify-content-center mt-3">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/tasks(sort=${currentSort}, direction=${currentDirection}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=${page.number - 1}, size=${pageSize})}">
                        Previous
                    </a>
                </li>

                <li th:each="p : ${pageNumbers}" class="page-item"
                    th:classappend="${p == page.number} ? 'active'">
                    <a class="page-link"
                       th:text="${p + 1}"
                       th:href="@{/tasks(sort=${currentSort}, direction=${currentDirection}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=${p}, size=${pageSize})}"></a>
                </li>

                <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/tasks(sort=${currentSort}, direction=${currentDirection}, title=${searchTitle}, status=${selectedStatus}, categoryId=${selectedCategory}, dueAfter=${dueAfter}, dueBefore=${dueBefore}, page=${page.number + 1}, size=${pageSize})}">
                        Next
                    </a>
                </li>
            </ul>
        </nav>
    </div>

</div>
</body>
</html>